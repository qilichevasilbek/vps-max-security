#!/bin/bash
# Module 19: Targeted CVE mitigations
# Source: Ubuntu Security Notices (Feb 2026), CISA KEV Catalog

check_cve_patches() {
    # Check that kernel and critical packages are at latest versions
    local updates
    updates="$(apt list --upgradable 2>/dev/null | grep -cE '(linux-image|sudo|libpam|nf_tables)' || true)"
    [[ "${updates}" -eq 0 ]]
}

apply_cve_patches() {
    log_step "Checking for targeted CVE patches..."

    # CVE-2025-21756 (Vsock) — kernel update
    # CVE-2024-1086 (nf_tables) — kernel update
    # CVE-2025-32463 (sudo chroot) — sudo update
    # CVE-2025-8941 (PAM race) — libpam update
    log_step "Updating kernel and critical packages..."
    apt update -y
    apt install --only-upgrade linux-image-generic sudo libpam-modules -y 2>/dev/null || true

    # CVE-2024-53104 (UVC driver) — already blocked in module 18

    # Block vsock if not needed (CVE-2025-21756 mitigation)
    if ! lsmod | grep -q "vsock" 2>/dev/null; then
        log_step "Blocking vsock module (CVE-2025-21756 mitigation)..."
        if [[ ! -f /etc/modprobe.d/vsock-block.conf ]]; then
            cat > /etc/modprobe.d/vsock-block.conf << 'EOF'
# CVE-2025-21756 — VM escape via vsock
install vsock /bin/true
blacklist vsock
blacklist vmw_vsock_virtio_transport
blacklist vmw_vsock_vmci_transport
EOF
        fi
    fi

    # Restrict nf_tables if loaded (CVE-2024-1086 mitigation)
    if [[ -f /proc/sys/net/netfilter/nf_conntrack_max ]]; then
        log_step "Ensuring nf_tables kernel module is updated..."
    fi

    log_success "CVE patches applied"
}

audit_cve_patches() {
    local updates
    updates="$(apt list --upgradable 2>/dev/null | grep -cE '(linux-image|sudo|libpam)' || true)"
    [[ "${updates}" -eq 0 ]]
}
